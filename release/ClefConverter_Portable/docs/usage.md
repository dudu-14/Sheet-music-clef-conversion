# 使用说明

本文档详细介绍如何使用谱号转换器进行中音谱号到高音谱号的转换。

## 快速开始

### Web界面使用

1. **启动Web服务**
   ```bash
   python main.py --web
   ```

2. **打开浏览器**
   访问 http://localhost:5000

3. **上传乐谱图片**
   - 点击上传区域或拖拽图片文件
   - 支持格式：PNG, JPG, BMP, TIFF
   - 最大文件大小：100MB

4. **选择处理选项**
   - 高精度模式：提高识别准确率，但处理时间更长
   - 输出格式：PNG图片、PDF文档、MIDI音频

5. **开始转换**
   点击"开始转换"按钮，等待处理完成

6. **下载结果**
   转换完成后，点击相应按钮下载结果文件

### 命令行使用

#### 基本转换
```bash
# 转换单个文件
python main.py input.png -o output.png

# 指定输出目录
python main.py input.png -o output/
```

#### 高级选项
```bash
# 高精度模式
python main.py input.png -o output.png --high-quality

# 多格式输出
python main.py input.png -o output --formats png,pdf,midi

# 详细输出
python main.py input.png -o output.png --verbose
```

#### 批量处理
```bash
# 处理目录中的所有图片
python main.py input_dir/ -o output_dir/ --batch

# 使用通配符
python main.py *.png -o output_dir/ --batch

# 递归处理子目录
python main.py input_dir/ -o output_dir/ --batch --recursive
```

## 详细功能说明

### 支持的输入格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| PNG | .png | 推荐格式，支持透明背景 |
| JPEG | .jpg, .jpeg | 常见格式，但可能有压缩损失 |
| BMP | .bmp | 无损格式，文件较大 |
| TIFF | .tiff, .tif | 高质量格式，支持多页 |
| GIF | .gif | 支持，但不推荐用于乐谱 |

### 支持的输出格式

| 格式 | 扩展名 | 说明 | 用途 |
|------|--------|------|------|
| PNG | .png | 高质量图片 | 查看、打印、编辑 |
| PDF | .pdf | 矢量文档 | 打印、分享、存档 |
| MIDI | .midi, .mid | 音频文件 | 播放、编辑、分析 |
| SVG | .svg | 矢量图形 | 网页显示、缩放 |

### 处理选项详解

#### 高精度模式
- **启用时机**：图片质量较差、音符密集、手写乐谱
- **处理时间**：比普通模式慢2-3倍
- **准确率提升**：通常提高10-20%
- **内存占用**：增加约50%

#### 图像预处理
自动执行以下处理步骤：
1. **格式验证**：检查文件格式和完整性
2. **图像增强**：调整对比度、亮度、锐度
3. **噪声去除**：消除扫描噪点和干扰
4. **自动旋转**：校正图像倾斜
5. **区域裁剪**：提取五线谱区域

#### 音乐识别
1. **谱号检测**：识别中音谱号位置
2. **五线谱检测**：定位五线谱线条
3. **音符识别**：检测音符头、符干、符尾
4. **节拍识别**：识别拍号、小节线
5. **调号识别**：检测升降号

#### 谱号转换
1. **位置映射**：中音谱号位置转换为高音谱号位置
2. **音高保持**：确保MIDI音高值不变
3. **加线处理**：自动添加必要的加线
4. **布局优化**：调整音符间距和排版

## 使用技巧

### 获得最佳效果的建议

#### 图片质量
- **分辨率**：至少300 DPI
- **对比度**：黑色音符，白色背景
- **清晰度**：避免模糊和重影
- **完整性**：包含完整的五线谱和谱号

#### 扫描设置
- 使用平板扫描仪而非手机拍照
- 选择灰度或黑白模式
- 避免阴影和反光
- 保持乐谱平整

#### 文件准备
- 裁剪掉不必要的边缘
- 确保图像方向正确
- 移除水印和注释
- 分离多页乐谱

### 常见问题处理

#### 识别准确率低
**可能原因**：
- 图片质量差
- 手写乐谱
- 复杂的音符排列
- 非标准谱号

**解决方案**：
- 启用高精度模式
- 提高图片分辨率
- 手动清理图片
- 分段处理复杂乐谱

#### 转换结果不正确
**可能原因**：
- 原图不是中音谱号
- 音符识别错误
- 调号处理问题

**解决方案**：
- 确认原图确实是中音谱号
- 检查识别日志
- 手动校正MIDI文件
- 联系技术支持

#### 处理速度慢
**可能原因**：
- 图片文件过大
- 启用了高精度模式
- 系统资源不足

**解决方案**：
- 压缩图片大小
- 关闭高精度模式
- 增加系统内存
- 使用GPU加速

## 命令行参数详解

### 基本参数
```bash
python main.py [输入文件] -o [输出路径] [选项]
```

### 所有参数

| 参数 | 简写 | 类型 | 默认值 | 说明 |
|------|------|------|--------|------|
| `input` | - | 字符串 | 必需 | 输入图片路径或模式 |
| `--output` | `-o` | 字符串 | 必需 | 输出路径 |
| `--formats` | - | 字符串 | png | 输出格式，逗号分隔 |
| `--batch` | - | 标志 | False | 批量处理模式 |
| `--high-quality` | - | 标志 | False | 高精度模式 |
| `--recursive` | - | 标志 | False | 递归处理子目录 |
| `--web` | - | 标志 | False | 启动Web界面 |
| `--port` | - | 整数 | 5000 | Web服务端口 |
| `--host` | - | 字符串 | 127.0.0.1 | Web服务主机 |
| `--verbose` | `-v` | 标志 | False | 详细输出 |
| `--version` | - | 标志 | False | 显示版本信息 |

### 使用示例

```bash
# 基本转换
python main.py score.png -o converted.png

# 批量处理
python main.py "*.png" -o output/ --batch

# 多格式输出
python main.py score.png -o output --formats png,pdf,midi

# 高精度批量处理
python main.py input_dir/ -o output_dir/ --batch --high-quality

# 启动Web服务（自定义端口）
python main.py --web --port 8080 --host 0.0.0.0

# 详细输出模式
python main.py score.png -o converted.png --verbose
```

## 输出文件说明

### 文件命名规则
- **单文件转换**：使用指定的输出文件名
- **批量转换**：`原文件名_converted.扩展名`
- **多格式输出**：`原文件名_converted.格式`

### 输出目录结构
```
output/
├── score1_converted.png
├── score1_converted.pdf
├── score1_converted.midi
├── score2_converted.png
└── ...
```

### 文件内容说明

#### PNG/PDF文件
- 包含转换后的高音谱号乐谱
- 保持原始布局和格式
- 自动调整音符位置

#### MIDI文件
- 包含音符的时间和音高信息
- 可用于音频播放和编辑
- 保持原始的节拍和调性

## 性能优化

### 系统配置建议
- **CPU**：多核处理器，主频2.5GHz以上
- **内存**：8GB以上，处理大文件时需要更多
- **存储**：SSD硬盘，提高文件读写速度
- **GPU**：支持CUDA的显卡（可选）

### 处理优化
- 批量处理时使用多进程
- 大文件分块处理
- 启用GPU加速（如果可用）
- 调整图片分辨率

## 下一步

- 查看 [API文档](api.md) 了解编程接口
- 阅读 [故障排除](troubleshooting.md) 解决常见问题
- 参考 [开发指南](development.md) 参与项目开发
