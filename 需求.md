# 谱号转换器需求文档

## 1. 项目概述

### 1.1 业务目标

开发一个智能谱号转换器，能够识别包含中音谱号的乐谱图片，并将其转换为高音谱号的乐谱图片输出。

### 1.2 核心功能

- 光学音乐识别（OMR）：从图片中识别乐谱内容
- MIDI 数据处理：将识别结果转换为 MIDI 格式
- 谱号转换：将中音谱号音符转换为高音谱号对应音符
- 图像生成：输出转换后的高音谱号乐谱图片

## 2. 用户故事与验收标准

### 用户故事 1：图片输入与识别

**As a** 音乐工作者  
**I want to** 上传包含中音谱号的乐谱图片  
**So that** 系统能够识别其中的音符和节拍信息

**验收标准：**

- [AC1] 支持常见图片格式（PNG, JPG, JPEG, BMP）
- [AC2] 能够识别标准中音谱号记号
- [AC3] 准确识别音符位置、时值和音高
- [AC4] 识别准确率 ≥ 85%（基于标准测试集）
- [AC5] 支持单声部乐谱识别

### 用户故事 2：谱号转换

**As a** 音乐工作者  
**I want to** 将中音谱号转换为高音谱号  
**So that** 我可以用更熟悉的谱号阅读乐谱

**验收标准：**

- [AC1] 正确计算中音谱号到高音谱号的音高转换（中音谱号 C4 对应高音谱号的位置）
- [AC2] 保持原有的节拍和时值不变
- [AC3] 保持原有的调号和拍号
- [AC4] 处理超出高音谱号常规范围的音符（使用加线）

### 用户故事 3：图像输出

**As a** 音乐工作者  
**I want to** 获得转换后的高音谱号乐谱图片  
**So that** 我可以打印或分享转换后的乐谱

**验收标准：**

- [AC1] 输出清晰的高音谱号乐谱图片
- [AC2] 保持原图的分辨率和清晰度
- [AC3] 支持多种输出格式（PNG, PDF）
- [AC4] 输出图片包含正确的高音谱号记号
- [AC5] 音符排版整齐，符合标准乐谱格式

## 3. 功能需求

### 3.1 核心功能模块

#### 3.1.1 图像预处理模块

- 图像去噪和增强
- 自动旋转和裁剪
- 二值化处理

#### 3.1.2 OMR 识别模块

- 谱号识别（重点识别中音谱号）
- 音符识别（位置、时值、音高）
- 节拍线识别
- 调号和拍号识别

#### 3.1.3 MIDI 转换模块

- 将识别结果转换为 MIDI 数据
- 音符时间戳计算
- 音高数值转换

#### 3.1.4 谱号转换模块

- 中音谱号到高音谱号的音高映射
- 音符位置重新计算
- 加线处理逻辑

#### 3.1.5 乐谱渲染模块

- 高音谱号乐谱生成
- 音符排版和布局
- 图像输出和格式转换

### 3.2 辅助功能

- 批量处理支持
- 处理进度显示
- 错误处理和用户反馈
- 预览功能

## 4. 技术约束

### 4.1 性能要求

- 单张图片处理时间 ≤ 30 秒
- 支持最大分辨率：65536x65536 像素
- 内存占用 ≤ 2GB

### 4.2 兼容性要求

- 支持 Windows 10/11
- Python 3.8+
- 支持 CPU 和 GPU 加速（可选）

### 4.3 质量要求

- 识别准确率 ≥ 85%
- 转换正确率 ≥ 95%
- 系统稳定性 ≥ 99%

## 5. 非功能性需求

### 5.1 可用性

- 提供简洁的命令行界面
- 可选的图形用户界面（网页）
- 详细的错误信息和使用说明

### 5.2 可维护性

- 模块化设计，便于扩展
- 完整的代码注释和文档
- 单元测试覆盖率 ≥ 80%

### 5.3 安全性

- 输入验证和文件类型检查
- 防止恶意文件上传
- 临时文件安全清理

## 6. 风险评估

### 6.1 技术风险

- **高风险**：OMR 识别准确率可能不达标
  - 缓解措施：使用成熟的 OMR 库（如 oemer），建立测试数据集
- **中风险**：复杂乐谱识别困难
  - 缓解措施：先支持简单单声部乐谱，逐步扩展
- **低风险**：图像质量影响识别效果
  - 缓解措施：添加图像预处理和质量检查

### 6.2 业务风险

- **中风险**：用户对转换结果不满意
  - 缓解措施：提供预览功能，允许手动调整
- **低风险**：处理速度过慢
  - 缓解措施：优化算法，提供进度显示

## 7. 验收测试计划

### 7.1 功能测试

- 使用标准中音谱号乐谱进行识别测试
- 验证转换后的音高正确性
- 测试各种图片格式和质量

### 7.2 性能测试

- 测试不同分辨率图片的处理时间
- 内存使用情况监控
- 批量处理性能测试

### 7.3 用户验收测试

- 邀请音乐专业人士进行实际使用测试
- 收集用户反馈和改进建议

## 8. 交付物清单

1. 完整的 Python 应用程序
2. 用户使用手册
3. 技术文档和 API 说明
4. 测试报告和测试用例
5. 示例图片和转换结果
6. 安装和部署指南

## 9. 项目里程碑

- **里程碑 1**：完成需求分析和系统设计（1 天）
- **里程碑 2**：完成 OMR 识别模块（3 天）
- **里程碑 3**：完成谱号转换逻辑（2 天）
- **里程碑 4**：完成图像生成模块（2 天）
- **里程碑 5**：完成集成测试和优化（2 天）
- **里程碑 6**：完成文档和交付（1 天）

**总计：11 天**
